{% extends "core/base.html" %}

{% block content %}

<div class="page-content">

    <h2>
        Chat with {{ other_user.username }}

        {% if other_user.profile.last_activity|timesince < "1 minute" %}
            <span style="color:green;">ðŸŸ¢ Online</span>
        {% else %}
            <small>Last seen {{ other_user.profile.last_activity|timesince }} ago</small>
        {% endif %}
    </h2>

    <div class="chat-card">

        <div id="chat-box" class="chat-box">

            {% for m in messages %}
                {% if m.sender == request.user %}
                    <!-- My message -->
                    <div class="msg-row me">
                        <div class="msg-bubble me">

                            {% if m.image %}
                                <img src="{{ m.image.url }}">
                            {% endif %}

                            {% if m.text %}
                                <p>{{ m.text }}</p>
                            {% endif %}

                        </div>
                    </div>
                {% else %}
                    <!-- Other message -->
                    <div class="msg-row other">
                        <div class="msg-bubble other">

                            {% if m.image %}
                                <img src="{{ m.image.url }}">
                            {% endif %}

                            {% if m.text %}
                                <p>{{ m.text }}</p>
                            {% endif %}

                        </div>
                    </div>
                {% endif %}
            {% endfor %}

        </div>

        <form method="POST" enctype="multipart/form-data" class="chat-input">
            {% csrf_token %}
            <input type="text" name="message" placeholder="Type message...">
            <input type="file" name="image">
            <button type="submit">Send</button>
        </form>

    </div>

</div>

<script>
    var chatBox = document.getElementById("chat-box");
    if (chatBox) {
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Auto refresh chat every 3 seconds
    setInterval(function() {
        fetch(window.location.href)
            .then(response => response.text())
            .then(html => {
                let parser = new DOMParser();
                let doc = parser.parseFromString(html, "text/html");

                let newChat = doc.getElementById("chat-box");
                let currentChat = document.getElementById("chat-box");

                if (newChat && currentChat) {
                    currentChat.innerHTML = newChat.innerHTML;
                    currentChat.scrollTop = currentChat.scrollHeight;
                }
            });
    }, 3000);
</script>

{% endblock %}
